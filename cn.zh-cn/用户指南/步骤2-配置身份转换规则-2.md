# 步骤2：配置身份转换规则<a name="iam_08_0008"></a>

在IAM上创建身份提供商后，联邦用户在华为云中的用户名默认为“FederationUser”，且联邦用户仅能访问华为云，没有任何权限。您可以在IAM控制台配置身份转换规则，实现：

-   企业管理系统用户在华为云中显示不同的用户名。
-   赋予企业管理系统用户使用华为云资源的权限。由于华为云权限的最小授权单位是用户组，因此需要建立联邦用户与IAM用户组的映射关系，从而使得联邦用户获得对应用户组的权限，使用华为云上的资源。请确保已创建需要映射的IAM用户组，创建IAM用户组并授权请参见：[创建用户组并授权](创建用户组并授权.md)。

>![](public_sys-resources/icon-note.gif) **说明：** 
>-   修改身份转换规则后，对已登录的联邦用户不会即时生效，需重新登录后新规则才可生效。
>-   如果需要修改用户的权限，修改用户所属用户组的权限即可，修改后，需要重启企业IdP使设置生效。

## 前提条件<a name="section52965331"></a>

已在本系统创建身份提供商，并验证身份提供商的登录链接可以正常使用，如何创建并验证身份提供商请参见：[步骤1：创建身份提供商](步骤1-创建身份提供商-1.md)。

## 操作步骤<a name="zh-cn_topic_0175818756_section49143529"></a>

您可以使用“创建规则”，IAM会将您填写的身份转换规则参数转换成JSON语言；也可以单击“编辑规则”直接编写JSON语言，编辑身份转换规则的详细说明和示例请参见：[身份转换规则详细说明](身份转换规则详细说明.md)。

-   **创建规则**
    1.  管理员在统一身份认证服务的左侧导航窗格中，单击“身份提供商”。
    2.  在身份提供商列表中，选择您创建的身份提供商，单击“修改”。
    3.  在“身份转换规则”区域单击“创建规则”。

        **图 1**  创建规则-1<a name="fig105921746112014"></a>  
        ![](figures/创建规则-1-12.png "创建规则-1-12")

        **图 2**  创建规则-2<a name="fig119361628122210"></a>  
        ![](figures/创建规则-2-13.png "创建规则-2-13")

        **表 1**  参数说明

        <a name="table89316364208"></a>
        <table><thead align="left"><tr id="row2093153612208"><th class="cellrowborder" valign="top" width="14.34%" id="mcps1.2.4.1.1"><p id="p6931236182020"><a name="p6931236182020"></a><a name="p6931236182020"></a>参数名</p>
        </th>
        <th class="cellrowborder" valign="top" width="21.97%" id="mcps1.2.4.1.2"><p id="p293143672016"><a name="p293143672016"></a><a name="p293143672016"></a>描述</p>
        </th>
        <th class="cellrowborder" valign="top" width="63.690000000000005%" id="mcps1.2.4.1.3"><p id="p393153613203"><a name="p393153613203"></a><a name="p393153613203"></a>说明</p>
        </th>
        </tr>
        </thead>
        <tbody><tr id="row19313642015"><td class="cellrowborder" valign="top" width="14.34%" headers="mcps1.2.4.1.1 "><p id="p39353612018"><a name="p39353612018"></a><a name="p39353612018"></a>用户名</p>
        </td>
        <td class="cellrowborder" valign="top" width="21.97%" headers="mcps1.2.4.1.2 "><p id="p179333616201"><a name="p179333616201"></a><a name="p179333616201"></a>联邦用户在华为云中显示的用户名，以下简称“联邦用户名”。</p>
        </td>
        <td class="cellrowborder" valign="top" width="63.690000000000005%" headers="mcps1.2.4.1.3 "><p id="p79310365201"><a name="p79310365201"></a><a name="p79310365201"></a>为了区分华为云的用户与联邦用户，建议此处配置用户名为“FederationUser-IdP<em id="i99373610205"><a name="i99373610205"></a><a name="i99373610205"></a>_</em>XXX”。其中“IdP”为身份提供商名称，如ADFS、Shibboleth等，用于区分不同身份提供商下的联邦用户；“XXX”为自定义的具体名称。</p>
        <div class="notice" id="note09317367206"><a name="note09317367206"></a><a name="note09317367206"></a><span class="noticetitle"> 须知： </span><div class="noticebody"><a name="ul898419111598"></a><a name="ul898419111598"></a><ul id="ul898419111598"><li>同一身份提供商的联邦用户名需要确保其唯一。如果同一身份提供商内出现重复的联邦用户名，则重名的联邦用户在华为云中对应同一个IAM用户。</li><li>用户名能包含大小写字母、空格、数字或特殊字符（-_.）且不能以数字开头。不能包含”、\"、\\、\n、\r等特殊字符。</li></ul>
        </div></div>
        </td>
        </tr>
        <tr id="row2093103632016"><td class="cellrowborder" valign="top" width="14.34%" headers="mcps1.2.4.1.1 "><p id="p1893183610205"><a name="p1893183610205"></a><a name="p1893183610205"></a>用户组</p>
        </td>
        <td class="cellrowborder" valign="top" width="21.97%" headers="mcps1.2.4.1.2 "><p id="p189303682010"><a name="p189303682010"></a><a name="p189303682010"></a>联邦用户在华为云中所属的用户组。</p>
        </td>
        <td class="cellrowborder" valign="top" width="63.690000000000005%" headers="mcps1.2.4.1.3 "><p id="p19319360203"><a name="p19319360203"></a><a name="p19319360203"></a>联邦用户拥有所属用户组的权限。</p>
        <div class="note" id="note477810272019"><a name="note477810272019"></a><a name="note477810272019"></a><span class="notetitle"> 说明： </span><div class="notebody"><p id="p1970415322015"><a name="p1970415322015"></a><a name="p1970415322015"></a>用户组名能包含大小写字母、空格、数字或特殊字符（-_.）且不能以数字开头。不能包含”、\"、\\、\n、\r等特殊字符。</p>
        </div></div>
        </td>
        </tr>
        <tr id="row1793143615209"><td class="cellrowborder" valign="top" width="14.34%" headers="mcps1.2.4.1.1 "><p id="p89363622013"><a name="p89363622013"></a><a name="p89363622013"></a>本规则生效条件</p>
        </td>
        <td class="cellrowborder" valign="top" width="21.97%" headers="mcps1.2.4.1.2 "><p id="p79353612203"><a name="p79353612203"></a><a name="p79353612203"></a>联邦用户拥有所选用户组权限的生效条件。</p>
        </td>
        <td class="cellrowborder" valign="top" width="63.690000000000005%" headers="mcps1.2.4.1.3 "><p id="p18931936142014"><a name="p18931936142014"></a><a name="p18931936142014"></a>当满足该生效条件时，联邦用户具有所属用户组的权限；当不满足生效条件时，该规则不生效，且不满足生效条件的用户无法访问华为云。一个身份转换规则最多可以创建10条生效条件。</p>
        <div class="note" id="note1931536132016"><a name="note1931536132016"></a><a name="note1931536132016"></a><span class="notetitle"> 说明： </span><div class="notebody"><a name="ul11932363202"></a><a name="ul11932363202"></a><ul id="ul11932363202"><li>一个规则可以创建多条生效条件，所有生效条件均满足，此规则才可以生效。</li><li>一个身份提供商可以创建多条规则，规则共同作用。如果所有规则对某个联邦用户都不生效，那么该联邦用户禁止访问华为云。</li></ul>
        </div></div>
        </td>
        </tr>
        </tbody>
        </table>

        示例：为企业管理系统管理员设定规则。

        -   用户名：FederationUser-IdP\_admin
        -   用户组：“admin“
        -   生效条件：“属性“：“\_NAMEID\_“；“条件“：“any\_one\_of“；“值“：“000000001“。

            表示仅用户ID为000000001的用户在华为云中映射的IAM用户名为FederationUser-IdP\_admin、具有“admin“用户组的权限。

    4.  在“创建规则“页面，单击“确定“。
    5.  在“修改身份提供商“页面，单击“确定“，使配置生效。

-   **编辑规则**
    1.  管理员登录华为云，进入IAM控制台，并在左侧导航窗格中，单击“身份提供商”。
    2.  在身份提供商列表中，选择您创建的身份提供商，单击“修改”。

        **图 3**  修改身份提供商<a name="fig2283236202017"></a>  
        ![](figures/修改身份提供商-10.png "修改身份提供商-10")

    3.  在“身份转换规则”区域单击“编辑规则”。
    4.  在编辑框内输入JSON格式的身份转换规则，具体说明请参见：[身份转换规则详细说明](身份转换规则详细说明.md)。
    5.  单击“校验规则”，对已编辑的规则进行语法校验。
    6.  界面提示“规则正确”：在“编辑规则“页面，单击“确定“；在“修改身份提供商“页面，单击“确定“，使配置生效。

        界面提示“JSON文件格式不完整”：请修改JSON语句，或单击“取消”，取消本次修改内容。



## 验证联邦用户权限<a name="section10240138122317"></a>

配置身份转换规则后，查看联邦用户是否已有相应权限。

1.  联邦用户登录。

    在IAM控制台的“身份提供商”页面，单击“操作”列的“查看”，进入“身份提供商基本信息”页面；单击“登录链接”右侧的“复制”，在浏览器中打开，输入企业管理系统用户名和密码，登录成功。

2.  查看联邦用户是否具有所属用户组的权限。

    例如，配置身份转换规则时，使联邦用户“ID1”对应IAM用户组“admin”，拥有所有云服务的权限。进入控制台，选择任一云服务，查看是否可以访问此服务。


## 相关操作<a name="zh-cn_topic_0175818756_section4140824420758"></a>

查看规则：在“身份转换规则“区域单击“查看规则“。新创建的身份转换规则在JSON文件中显示。JSON文件内容说明请参考：[身份转换规则详细说明](身份转换规则详细说明.md)。

